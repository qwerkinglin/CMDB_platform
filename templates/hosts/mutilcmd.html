{% extends 'base.html' %}
{% block head-css %}
    <link href="/static/css/plugins/jsTree/style.min.css" rel="stylesheet">
{% endblock %}

{% block content-wrapper %}
    <div class="col-lg-3">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>Host groups</h5>
                <div class="ibox-tools">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
{#                    <a class="close-link">#}
{#                        <i class="fa fa-times"></i>#}
{#                    </a>#}
                </div>
            </div>
            <div class="ibox-content">

                <div id="jstree1">
                    <ul>
                        <li data-jstree='{"type":"tree_top"}' class="jstree-open">Host groups
                            <ul>
                                <li data-jstree='{"type":"group"}' class="text-navy jstree-open jstree-unchecked">
                                    Ungrouped
                                    <ul>
                                        {% for all in request.user.bind_hosts.select_related %}
                                            <li data-jstree='{"type":"default"}' data-binduserid={{ all.id }}>{{ all }}</li>
                                        {% endfor %}
                                    </ul>
                                    <span class="badge badge-info">{{ request.user.bind_hosts.select_related.count }}</span>
                                </li>
                            </ul>
                            <ul>
                                {% for group in request.user.host_groups.select_related %}
                                    {% for c in group.bindhosttogroup_set.all %}
                                        <li data-jstree='{"type":"group"}' class="jstree-closed jstree-unchecked">
                                            {{ group.name }}
                                            <ul>
                                                {% for h in group.bindhosttogroup_set.all %}
                                                    {% for server in h.bind_hosts.all %}
                                                        <li data-jstree='{"type":"default"}' data-binduserid={{ server.id }}>{{ server }}</li>
                                                    {% endfor %}
                                                {% endfor %}
                                            </ul>
                                            <span class="badge badge-info">{{ c.bind_hosts.all.count }}</span>
                                        </li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </li>
                    </ul>
                </div>

            </div>
        </div>
        </div>

    <div class="col-lg-9">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>Batch Commands</h5>
                <div class="ibox-tools">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
{#                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">#}
{#                        <i class="fa fa-wrench"></i>#}
{#                    </a>#}
{#                    <ul class="dropdown-menu dropdown-user">#}
{#                        <li><a href="#">Config option 1</a>#}
{#                        </li>#}
{#                        <li><a href="#">Config option 2</a>#}
{#                        </li>#}
{#                    </ul>#}
{#                    <a class="close-link">#}
{#                        <i class="fa fa-times"></i>#}
{#                    </a>#}
                </div>
            </div>
            <div class="ibox-content">
                <div class="input-group">
                    <input id="cmd_text" type="text" class="form-control"><span class="input-group-btn"><button type="button" class="btn btn-primary" onclick="SubmitTask('multi_cmd')">Run!</button></span>
                </div>
                <div id="err-msg"></div>
            </div>
        </div>

        <div class="ibox">
            <div class="ibox-title">
                <h5>Commands return information</h5>
                <div class="ibox-tools">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                    <a class="fullscreen-link">
                        <i class="fa fa-expand"></i>
                    </a>
                </div>
            </div>
            <div id="result-box" class="ibox-content">
                <h3><strong>Haven't run commands yet!</strong></h3>
            </div>
        </div>
    </div>

{% endblock %}

{% block bottom-js %}
    <script src="/static/js/plugins/jsTree/jstree.min.js"></script>

    <style>
        .jstree-open > .jstree-anchor > .fa-folder:before {
            content: "\f07c";
        }

        .jstree-default .jstree-icon.none {
            width: 0;
        }
    </style>

    <script>
        $(document).ready(function(){
            $('#jstree1').jstree({
                'core' : {
                    'check_callback' : true ,
                    'dblclick_toggle' : false ,
                },
                'plugins' : [ 'types', 'dnd','checkbox' ],
                "checkbox" : {
                    "keep_selected_style" : false
                },
                'types' : {
                    'default' : {
                        'icon' : 'fa fa-desktop'
                    },
                    'html' : {
                        'icon' : 'fa fa-file-code-o'
                    },
                    'svg' : {
                        'icon' : 'fa fa-file-picture-o'
                    },
                    'css' : {
                        'icon' : 'fa fa-file-code-o'
                    },
                    'img' : {
                        'icon' : 'fa fa-file-image-o'
                    },
                    'js' : {
                        'icon' : 'fa fa-file-text-o'
                    },
                    'tree_top' : {
                        'icon' : 'fa fa-sitemap'
                    },
                    'group' : {
                        'icon' : 'fa fa-folder'
                    },
                }
            });
        });
    </script>

    <script>
    function SubmitTask(task_type){
        if (task_type == 'multi_cmd'){
            FormVerification(task_type);
        }
    }

    function FormVerification(task_type){
        var err_list = [];
        var data_list = {};
        if (task_type == 'multi_cmd'){
            var selected_hosts = VerifyHostSelection();
            data_list['selected_hosts'] = selected_hosts;
            var cmd_text = $.trim($("#cmd_text").val());
            data_list['cmd'] = cmd_text;
            data_list['task_type'] = task_type;
            if (selected_hosts.length == 0){
                err_list.push(['Authentication Failed',"Tip: haven`t select hosts!"])
            }
            if (cmd_text.length == 0){
                err_list.push(['Authentication Failed',"Tip: haven`t enter a command!"])
            }
        }

        if (err_list.length > 0){
            $("#err-msg").html("");
            $.each(err_list,function(index,item){
                var err_msg = '<div class="alert-warning alert-dismissable">' + item[1] + '</div>'
                $("#err-msg").append(err_msg);
            })
        }else{
            $("#err-msg").html("");
            //提交任务到后台
            data_list['csrfmiddlewaretoken'] = $("input[name='csrfmiddlewaretoken']").val();
            $.post("{% url 'submit_task' %}", data_list, function(callback){
                console.log(callback);
                task_id_obj = JSON.parse(callback);
                console.log(task_id_obj)
                RefreshGetTaskResult(task_id_obj.task_id);
            });  //end post
        }
    }

    function VerifyHostSelection(){
        var selected_hosts = [];
        var all_hosts = $('#jstree1').jstree('get_bottom_checked',true);
        $.each(all_hosts,function(i,n){
            var servers = n.data.binduserid;
            selected_hosts.push(servers)
        });
        return selected_hosts;
    }

    function RefreshGetTaskResult(task_id){
        GetTaskResult(task_id);
{#        GetTaskResultInterval = setInterval(function(){#}
{#            GetTaskResult(task_id);#}
{#        },100000);#}
    }

    function GetTaskResult(task_id){
        $.getJSON("{% url 'get_task_result' %}", {task_id:task_id}, function(callback){
            console.log("----task err----");
            PrintOnPage(callback);
        }); //end getJSON
    }

    function PrintOnPage(callback){
        $('#result-box').html("");
        $.each(callback,function(index,item){
            var row_html =  '<div class="ibox">'+
                                '<div class="ibox-title">'+
                                    '<h5>'+item.bind_host__host_user__username+'@'+item.bind_host__host__hostname+'</h5>'+
                                    '<div class="ibox-tools">'+
                                        '<label class="label label-info">'+item.result+'</label>'+
                                        '<label class="label label-info">'+item.bind_host__host__wan_ip+'|'+item.bind_host__host__lan_ip+'</label>'+
                                        '<label class="label label-info">'+item.date+'</label>'+
                                        '<a class="collapse-link">'+
                                            '<i class="fa fa-chevron-up"></i>'+
                                        '</a>'+
                                    '</div>'+
                                '</div>'+
                                '<div class="ibox-content">'+
                                    '<div class="scroll_content">'+
                                        '<pre>'+item.event_log+'</pre>'+
                                    '</div>'+
                                '</div>'+
                            '</div>'
            $("#result-box").append(row_html);
        }); //end each

        $('.scroll_content').slimscroll({
            height: '150px'
        });
    }
    </script>
{% endblock %}